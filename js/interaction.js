// interaction.js„Å´‰ª•‰∏ã„ÅÆÈñ¢Êï∞„ÇíËøΩÂä†Ôºö

// „É™„Çµ„Ç§„Ç∫ÈñãÂßã
function startResize(e, character, position) {
    console.log('üîÑ „É™„Çµ„Ç§„Ç∫ÈñãÂßã:', character.name, position);
    
    isResizing = true;
    selectedElement = character;
    selectedCharacter = character;
    
    const coords = getCanvasCoordinates(e);
    const panel = panels.find(p => p.id === character.panelId);
    
    if (!panel) return;
    
    // „É™„Çµ„Ç§„Ç∫ÈñãÂßãÊôÇ„ÅÆÊÉÖÂ†±„Çí‰øùÂ≠ò
    resizeStartData = {
        character: character,
        position: position,
        startX: coords.x,
        startY: coords.y,
        startScale: character.scale,
        startCharX: character.x,
        startCharY: character.y,
        panel: panel
    };
    
    // „Éâ„Ç≠„É•„É°„É≥„ÉàÂÖ®‰Ωì„Åß„Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñ
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('mouseup', endResize);
}

// „É™„Çµ„Ç§„Ç∫Âá¶ÁêÜ
function handleResize(e) {
    if (!isResizing || !resizeStartData.character) return;
    
    const coords = getCanvasCoordinates(e);
    const data = resizeStartData;
    
    // „Éû„Ç¶„Çπ„ÅÆÁßªÂãïÈáè„ÇíË®àÁÆó
    const deltaX = coords.x - data.startX;
    const deltaY = coords.y - data.startY;
    
    // ‰ΩçÁΩÆ„Å®„Çπ„Ç±„Éº„É´„ÅÆË™øÊï¥ÊñπÂêë„ÇíÊ±∫ÂÆö
    let scaleChange = 0;
    let positionChangeX = 0;
    let positionChangeY = 0;
    
    switch (data.position) {
        case 'bottom-right':
            // Âè≥‰∏ãÔºö„Çπ„Ç±„Éº„É´„Ç¢„ÉÉ„Éó„ÄÅ‰ΩçÁΩÆÂ§âÊõ¥„Å™„Åó
            scaleChange = (deltaX + deltaY) / 200;
            break;
            
        case 'top-left':
            // Â∑¶‰∏äÔºö„Çπ„Ç±„Éº„É´„Ç¢„ÉÉ„Éó„ÄÅ‰ΩçÁΩÆ„ÇíÂ∑¶‰∏ä„Å´ÁßªÂãï
            scaleChange = -(deltaX + deltaY) / 200;
            positionChangeX = deltaX / data.panel.width;
            positionChangeY = deltaY / data.panel.height;
            break;
            
        case 'top-right':
            // Âè≥‰∏äÔºö„Çπ„Ç±„Éº„É´„Ç¢„ÉÉ„Éó„ÄÅY‰ΩçÁΩÆ„Çí‰∏ä„Å´ÁßªÂãï
            scaleChange = (deltaX - deltaY) / 200;
            positionChangeY = deltaY / data.panel.height;
            break;
            
        case 'bottom-left':
            // Â∑¶‰∏ãÔºö„Çπ„Ç±„Éº„É´„Ç¢„ÉÉ„Éó„ÄÅX‰ΩçÁΩÆ„ÇíÂ∑¶„Å´ÁßªÂãï
            scaleChange = (-deltaX + deltaY) / 200;
            positionChangeX = deltaX / data.panel.width;
            break;
            
        case 'right':
            // Âè≥Ëæ∫ÔºöÊ®™ÊñπÂêë„ÅÆ„Åø„Çπ„Ç±„Éº„É´
            scaleChange = deltaX / 300;
            break;
            
        case 'left':
            // Â∑¶Ëæ∫ÔºöÊ®™ÊñπÂêë„ÅÆ„Åø„Çπ„Ç±„Éº„É´„ÄÅ‰ΩçÁΩÆË™øÊï¥
            scaleChange = -deltaX / 300;
            positionChangeX = deltaX / data.panel.width;
            break;
            
        case 'bottom':
            // ‰∏ãËæ∫ÔºöÁ∏¶ÊñπÂêë„ÅÆ„Åø„Çπ„Ç±„Éº„É´
            scaleChange = deltaY / 300;
            break;
            
        case 'top':
            // ‰∏äËæ∫ÔºöÁ∏¶ÊñπÂêë„ÅÆ„Åø„Çπ„Ç±„Éº„É´„ÄÅ‰ΩçÁΩÆË™øÊï¥
            scaleChange = -deltaY / 300;
            positionChangeY = deltaY / data.panel.height;
            break;
    }
    
    // Êñ∞„Åó„ÅÑ„Çπ„Ç±„Éº„É´„ÇíË®àÁÆóÔºàÂà∂Èôê‰ªò„ÅçÔºâ
    const newScale = Math.max(0.3, Math.min(3.0, data.startScale + scaleChange));
    
    // Êñ∞„Åó„ÅÑ‰ΩçÁΩÆ„ÇíË®àÁÆóÔºà„Éë„Éç„É´ÂÜÖÂà∂ÈôêÔºâ
    const newX = Math.max(0, Math.min(1, data.startCharX + positionChangeX));
    const newY = Math.max(0, Math.min(1, data.startCharY + positionChangeY));
    
    // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂÄ§„ÇíÊõ¥Êñ∞
    data.character.scale = newScale;
    data.character.x = newX;
    data.character.y = newY;
    
    // Ë°®Á§∫Êõ¥Êñ∞
    updateCharacterOverlay();
    updateControlsFromElement();
    
    console.log('üîÑ „É™„Çµ„Ç§„Ç∫‰∏≠:', {
        scale: newScale.toFixed(2),
        x: newX.toFixed(2),
        y: newY.toFixed(2)
    });
}

// „É™„Çµ„Ç§„Ç∫ÁµÇ‰∫Ü
function endResize(e) {
    if (!isResizing) return;
    
    console.log('üîÑ „É™„Çµ„Ç§„Ç∫ÁµÇ‰∫Ü');
    
    isResizing = false;
    resizeStartData = {};
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
    document.removeEventListener('mousemove', handleResize);
    document.removeEventListener('mouseup', endResize);
}





// ===== „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„É¢„Ç∏„É•„Éº„É´ =====

function initializeInteraction() {
    console.log('üñ±Ô∏è „Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„É¢„Ç∏„É•„Éº„É´ÂàùÊúüÂåñ');
    setupEventListeners();
}

// ===== „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö =====
// setupEventListenersÈñ¢Êï∞„Çí‰øÆÊ≠£
function setupEventListeners() {
    console.log('üìã „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö‰∏≠...');
    
    if (!canvas) {
        console.error('‚ùå „Ç≠„É£„É≥„Éê„ÇπË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    // „Ç≠„É£„É≥„Éê„Çπ„Ç§„Éô„É≥„Éà
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    
    // ===== ËøΩÂä†Ôºö„Çà„ÇäÁ¢∫ÂÆü„Å™mouseupÂá¶ÁêÜ =====
    document.addEventListener('mouseup', function(e) {
        if (isDragging) {
            console.log('üñ±Ô∏è „Éâ„Ç≠„É•„É°„É≥„Éàmouseup - „Éâ„É©„ÉÉ„Ç∞Âº∑Âà∂ÁµÇ‰∫Ü');
            isDragging = false;
            selectedElement = null;
        }
    });
    
    // ===== ËøΩÂä†Ôºö„Ç≠„Éº„Éú„Éº„Éâ„Åß„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü =====
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isDragging) {
            console.log('‚å®Ô∏è ESC„Ç≠„Éº - „Éâ„É©„ÉÉ„Ç∞Âº∑Âà∂ÁµÇ‰∫Ü');
            isDragging = false;
            selectedElement = null;
        }
    });
    
    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû
    document.querySelectorAll('.template-card').forEach(card => {
        card.addEventListener('click', function() {
            loadTemplate(this.dataset.template);
        });
    });
    
    // „Ç≠„É£„É©ÈÖçÁΩÆ„Éë„Çø„Éº„É≥
    document.querySelectorAll('.pattern-card').forEach(card => {
        card.addEventListener('click', function() {
            applyCharacterLayout(this.dataset.layout);
        });
    });
    
    // „Ç≠„É£„É©„ÇØ„Çø„ÉºËøΩÂä†
    document.querySelectorAll('.char-item').forEach(item => {
        item.addEventListener('click', function() {
            addCharacter(this.dataset.char);
        });
    });
    
    // Âêπ„ÅçÂá∫„ÅóËøΩÂä†
    document.querySelectorAll('.bubble-btn').forEach(btn => {
        if (btn.id === 'autoPlaceBubbles') {
            btn.addEventListener('click', autoPlaceBubbles);
        } else if (btn.dataset.bubble) {
            btn.addEventListener('click', function() {
                addBubble(this.dataset.bubble);
            });
        }
    });
    
    // „Ç∑„Éº„É≥ÈÅ∏Êäû
    document.querySelectorAll('.scene-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            analyzeScene(this.dataset.scene);
        });
    });
    
    // Êé®Â•®Ë®≠ÂÆöÈÅ©Áî®
    const applyBtn = document.getElementById('applyRecommendation');
    if (applyBtn) {
        applyBtn.addEventListener('click', applyRecommendation);
    }
    
    // Ë©≥Á¥∞Ë™øÊï¥
    const elementScale = document.getElementById('elementScale');
    const elementX = document.getElementById('elementX');
    const elementY = document.getElementById('elementY');
    
    if (elementScale) elementScale.addEventListener('input', updateSelectedElement);
    if (elementX) elementX.addEventListener('input', updateSelectedElement);
    if (elementY) elementY.addEventListener('input', updateSelectedElement);
    
    // ÂâäÈô§„Éú„Çø„É≥
    const deleteBtn = document.getElementById('deleteSelected');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteSelected);
    }
    
    // „Ç¨„Ç§„ÉâË°®Á§∫Âàá„ÇäÊõø„Åà
    const showGuides = document.getElementById('showGuides');
    if (showGuides) {
        showGuides.addEventListener('change', toggleGuides);
    }
    
    // Âá∫ÂäõÊ©üËÉΩ
    const exportBtns = {
        'exportToClipStudio': exportToClipStudio,
        'exportToPDF': exportToPDF,
        'exportToPNG': exportToPNG,
        'saveProject': saveProject
    };
    
    Object.entries(exportBtns).forEach(([id, handler]) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', handler);
        }
    });
    
    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener('keydown', handleKeyDown);
    
    console.log('‚úÖ „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
}


function createCharacterElement(character, panel) {
    const element = document.createElement('div');
    element.className = 'character-placeholder';
    element.dataset.charId = character.id;
    element.textContent = character.name;
    
    // ÂàùÊúü‰ΩçÁΩÆË®≠ÂÆö
    updateCharacterElementPosition(element, character, panel);
    element.style.cursor = 'move';
    
    // ===== „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº =====
    element.addEventListener('mousedown', function(e) {
        console.log('üë§ „Ç≠„É£„É©„ÇØ„Çø„Éº„ÇØ„É™„ÉÉ„ÇØ:', character.name, 'isDragging:', isDragging);
        e.stopPropagation();
        e.preventDefault();
        
        // Êó¢„Å´„Éâ„É©„ÉÉ„Ç∞‰∏≠„Å™„ÇâÂº∑Âà∂„É™„Çª„ÉÉ„Éà
        if (isDragging) {
            console.log('‚ö†Ô∏è „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖãÂº∑Âà∂„É™„Çª„ÉÉ„Éà');
            isDragging = false;
            selectedElement = null;
        }
        
        selectCharacter(character);
        
        // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        isDragging = true;
        selectedElement = character;
        
        const coords = getCanvasCoordinates(e);
        dragOffset.x = coords.x - (panel.x + panel.width * character.x);
        dragOffset.y = coords.y - (panel.y + panel.height * character.y);
        
        console.log('üöÄ „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã');
        
        // ===== ËøΩÂä†Ôºö„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åß„Éâ„É©„ÉÉ„Ç∞Âº∑Âà∂ÁµÇ‰∫Ü =====
        setTimeout(() => {
            if (isDragging) {
                console.log('‚è∞ „Çø„Ç§„É†„Ç¢„Ç¶„Éà - „Éâ„É©„ÉÉ„Ç∞Âº∑Âà∂ÁµÇ‰∫Ü');
                isDragging = false;
                selectedElement = null;
            }
        }, 5000); // 5ÁßíÂæå„Å´Âº∑Âà∂ÁµÇ‰∫Ü
    });
    
    // ===== ËøΩÂä†Ôºö„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„Éâ„É©„ÉÉ„Ç∞Âº∑Âà∂ÁµÇ‰∫Ü =====
    element.addEventListener('dblclick', function(e) {
        console.log('üë§ „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ - „Éâ„É©„ÉÉ„Ç∞Âº∑Âà∂ÁµÇ‰∫Ü');
        e.stopPropagation();
        isDragging = false;
        selectedElement = null;
    });
    
    return element;
}




// ===== „Éû„Ç¶„Çπ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ =====
function handleMouseDown(e) {
    console.log('üñ±Ô∏è „Éû„Ç¶„Çπ„ÉÄ„Ç¶„É≥ at:', e.target.className);
    
    // „Ç≠„É£„É©„ÇØ„Çø„ÉºË¶ÅÁ¥†„Å´Áõ¥Êé•„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
    if (e.target.classList.contains('character-placeholder')) {
        console.log('üéØ „Ç≠„É£„É©„ÇØ„Çø„ÉºË¶ÅÁ¥† - „Ç≠„É£„É≥„Éê„ÇπÂá¶ÁêÜ„Çπ„Ç≠„ÉÉ„Éó');
        return;
    }
    
    // Âêπ„ÅçÂá∫„ÅóË¶ÅÁ¥†„Å´Áõ¥Êé•„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÇÇ„Çπ„Ç≠„ÉÉ„Éó
    if (e.target.classList.contains('speech-bubble')) {
        console.log('üéØ Âêπ„ÅçÂá∫„ÅóË¶ÅÁ¥† - „Ç≠„É£„É≥„Éê„ÇπÂá¶ÁêÜ„Çπ„Ç≠„ÉÉ„Éó');
        return;
    }
    
    // ‰ª•‰∏ã„ÄÅÊó¢Â≠ò„ÅÆ„Ç≠„É£„É≥„Éê„ÇπÂá¶ÁêÜ...
    const coords = getCanvasCoordinates(e);
    const x = coords.x;
    const y = coords.y;
    
    // „Éë„Éç„É´„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    const clickedPanel = findPanelAt(x, y);
    if (clickedPanel) {
        if (e.shiftKey) {
            console.log('üìê „Éë„Éç„É´„Éâ„É©„ÉÉ„Ç∞„É¢„Éº„Éâ:', clickedPanel.id);
            selectPanel(clickedPanel);
            startDragging(e, clickedPanel);
        } else {
            console.log('üìê „Éë„Éç„É´ÈÅ∏Êäû:', clickedPanel.id);
            selectPanel(clickedPanel);
        }
        return;
    }
    
    // ‰Ωï„ÇÇ„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§
    clearSelection();
}

function handleMouseMove(e) {
    if (!isDragging || !selectedElement) return;
    
    const coords = getCanvasCoordinates(e);
    const x = coords.x;
    const y = coords.y;
    
    // „Éë„Éç„É´„ÅÆÂ†¥Âêà
    if (selectedElement.id && panels.includes(selectedElement)) {
        dragPanel(selectedElement, x, y);
        return;
    }
    
    // „Ç≠„É£„É©„ÇØ„Çø„Éº„Åæ„Åü„ÅØÂêπ„ÅçÂá∫„Åó„ÅÆÂ†¥Âêà
    if (selectedElement.panelId) {
        dragElement(selectedElement, x, y);
    }
}

function handleMouseUp(e) {
    if (isDragging) {
        console.log('üñ±Ô∏è „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü');
        isDragging = false;
        selectedElement = null; // ËøΩÂä†
    }
}

function handleCanvasClick(e) {
    if (isDragging) return;
    
    // „ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ„ÅØmousedown„ÅßË°å„ÅÜ„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÁâπ„Å´‰Ωï„ÇÇ„Åó„Å™„ÅÑ
}

// ===== „Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ =====
function startDragging(e, element) {
    isDragging = true;
    selectedElement = element;
    
    const coords = getCanvasCoordinates(e);
    
    if (element.id && panels.includes(element)) {
        // „Éë„Éç„É´„ÅÆÂ†¥Âêà
        dragOffset.x = coords.x - element.x;
        dragOffset.y = coords.y - element.y;
    } else if (element.panelId) {
        // „Ç≠„É£„É©„ÇØ„Çø„Éº„Åæ„Åü„ÅØÂêπ„ÅçÂá∫„Åó„ÅÆÂ†¥Âêà
        const panel = panels.find(p => p.id === element.panelId);
        if (panel) {
            dragOffset.x = coords.x - (panel.x + panel.width * element.x);
            dragOffset.y = coords.y - (panel.y + panel.height * element.y);
        }
    }
}

function dragPanel(panel, x, y) {
    panel.x = x - dragOffset.x;
    panel.y = y - dragOffset.y;
    
    // „Ç≠„É£„É≥„Éê„ÇπÂÜÖ„Å´Âà∂Èôê
    panel.x = Math.max(0, Math.min(canvas.width - panel.width, panel.x));
    panel.y = Math.max(0, Math.min(canvas.height - panel.height, panel.y));
    
    redrawCanvas();
    drawGuidelines();
    updateCharacterOverlay();
    updateBubbleOverlay();
    updateStatus();
}

function dragElement(element, x, y) {
    const panel = panels.find(p => p.id === element.panelId);
    if (!panel) return;
    
    // „Éë„Éç„É´ÂÜÖ„ÅÆÁõ∏ÂØæ‰ΩçÁΩÆ„Å´Â§âÊèõ
    const newX = (x - dragOffset.x - panel.x) / panel.width;
    const newY = (y - dragOffset.y - panel.y) / panel.height;
    
    // „Éë„Éç„É´ÂÜÖ„Å´Âà∂Èôê
    element.x = Math.max(0, Math.min(1, newX));
    element.y = Math.max(0, Math.min(1, newY));
    
    // Ë°®Á§∫Êõ¥Êñ∞
    if (selectedCharacter) {
        updateCharacterOverlay();
    } else if (selectedBubble) {
        updateBubbleOverlay();
    }
    
    updateControlsFromElement();
}

// ===== Ë¶ÅÁ¥†Ê§úÁ¥¢Èñ¢Êï∞ =====
function findCharacterAt(x, y) {
    for (let i = characters.length - 1; i >= 0; i--) {
        const character = characters[i];
        if (isCharacterAtPosition(character, x, y)) {
            return character;
        }
    }
    return null;
}

function findBubbleAt(x, y) {
    for (let i = speechBubbles.length - 1; i >= 0; i--) {
        const bubble = speechBubbles[i];
        if (isBubbleAtPosition(bubble, x, y)) {
            return bubble;
        }
    }
    return null;
}

function findPanelAt(x, y) {
    return panels.find(panel => isPointInPanel(x, y, panel));
}

// ===== ‰ΩçÁΩÆÂà§ÂÆö„Éò„É´„Éë„Éº =====
function isCharacterAtPosition(character, x, y) {
    const panel = panels.find(p => p.id === character.panelId);
    if (!panel) return false;
    
    const charX = panel.x + (panel.width * character.x) - 30;
    const charY = panel.y + (panel.height * character.y) - 20;
    const charWidth = 60 * character.scale;
    const charHeight = 40 * character.scale;
    
    return x >= charX && x <= charX + charWidth && 
           y >= charY && y <= charY + charHeight;
}

function isBubbleAtPosition(bubble, x, y) {
    const panel = panels.find(p => p.id === bubble.panelId);
    if (!panel) return false;
    
    const bubbleX = panel.x + (panel.width * bubble.x) - (bubble.width * bubble.scale / 2);
    const bubbleY = panel.y + (panel.height * bubble.y) - (bubble.height * bubble.scale / 2);
    const bubbleWidth = bubble.width * bubble.scale;
    const bubbleHeight = bubble.height * bubble.scale;
    
    return x >= bubbleX && x <= bubbleX + bubbleWidth && 
           y >= bubbleY && y <= bubbleY + bubbleHeight;
}

// ===== ÈÅ∏ÊäûÂá¶ÁêÜ =====
function selectCharacter(character) {
    selectedCharacter = character;
    selectedBubble = null;
    selectedPanel = null;
    selectedElement = character;
    updateCharacterOverlay();
    updateControlsFromElement();
    updateStatus();
}

function selectBubble(bubble) {
    selectedBubble = bubble;
    selectedCharacter = null;
    selectedPanel = null;
    selectedElement = bubble;
    updateBubbleOverlay();
    updateControlsFromElement();
    updateStatus();
}

function selectPanel(panel) {
    selectedPanel = panel;
    selectedCharacter = null;
    selectedBubble = null;
    selectedElement = null;
    redrawCanvas();
    drawGuidelines();
    updateStatus();
}

function clearSelection() {
    selectedPanel = null;
    selectedCharacter = null;
    selectedBubble = null;
    selectedElement = null;
    redrawCanvas();
    drawGuidelines();
    updateCharacterOverlay();
    updateBubbleOverlay();
    updateStatus();
}

// ===== „Ç≥„É≥„Éà„É≠„Éº„É´Êõ¥Êñ∞ =====
function updateControlsFromElement() {
    if (!selectedElement) return;
    
    const scaleEl = document.getElementById('elementScale');
    const xEl = document.getElementById('elementX');
    const yEl = document.getElementById('elementY');
    const typeEl = document.getElementById('elementType');
    const characterSettings = document.getElementById('characterSettings');
    
    if (scaleEl) scaleEl.value = selectedElement.scale || 1.0;
    if (xEl) xEl.value = selectedElement.x || 0.5;
    if (yEl) yEl.value = selectedElement.y || 0.5;
    
    if (typeEl && selectedCharacter) {
        typeEl.value = 'character';
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºË®≠ÂÆö„Éë„Éç„É´„ÇíË°®Á§∫
        if (characterSettings) {
            characterSettings.style.display = 'block';
            
            // ÁèæÂú®„ÅÆË®≠ÂÆöÂÄ§„ÇíÂèçÊò†
            const facingEl = document.getElementById('characterFacing');
            const gazeEl = document.getElementById('characterGaze');
            const poseEl = document.getElementById('characterPose');
            const expressionEl = document.getElementById('characterExpression');
            
            if (facingEl) facingEl.value = selectedCharacter.facing || 'front';
            if (gazeEl) gazeEl.value = selectedCharacter.gaze || 'center';
            if (poseEl) poseEl.value = selectedCharacter.pose || 'standing';
            if (expressionEl) expressionEl.value = selectedCharacter.expression || 'neutral';
        }
    } else {
        if (characterSettings) {
            characterSettings.style.display = 'none';
        }
        if (typeEl) typeEl.value = 'bubble';
    }
}

function updateSelectedElement() {
    if (!selectedElement) return;
    
    const scaleEl = document.getElementById('elementScale');
    const xEl = document.getElementById('elementX');
    const yEl = document.getElementById('elementY');
    
    if (scaleEl) selectedElement.scale = parseFloat(scaleEl.value);
    if (xEl) selectedElement.x = parseFloat(xEl.value);
    if (yEl) selectedElement.y = parseFloat(yEl.value);
    
    if (selectedCharacter) {
        updateCharacterOverlay();
    } else if (selectedBubble) {
        updateBubbleOverlay();
    }
    
    updateStatus();
}

// ===== ÂâäÈô§Âá¶ÁêÜ =====
function deleteSelected() {
    if (selectedCharacter) {
        characters = characters.filter(char => char.id !== selectedCharacter.id);
        selectedCharacter = null;
        updateCharacterOverlay();
        console.log('üë§ „Ç≠„É£„É©„ÇØ„Çø„ÉºÂâäÈô§');
    } else if (selectedBubble) {
        speechBubbles = speechBubbles.filter(bubble => bubble.id !== selectedBubble.id);
        selectedBubble = null;
        updateBubbleOverlay();
        console.log('üí¨ Âêπ„ÅçÂá∫„ÅóÂâäÈô§');
    }
    
    selectedElement = null;
    updateStatus();
    updateElementCount();
}

// ===== „Ç∑„Éº„É≥ÂàÜÊûê =====
function analyzeScene(sceneType) {
    currentScene = sceneType;
    
    console.log('üé≠ „Ç∑„Éº„É≥ÂàÜÊûê:', sceneType);
    
    // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÊõ¥Êñ∞
    document.querySelectorAll('.scene-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const targetBtn = document.querySelector(`[data-scene="${sceneType}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }
    
    // Êé®Â•®Ë®≠ÂÆöË°®Á§∫
    if (sceneRecommendations[sceneType]) {
        showSceneRecommendation(sceneType);
    }
}

function showSceneRecommendation(sceneType) {
    const recommendation = sceneRecommendations[sceneType];
    const panel = document.getElementById('sceneRecommendation');
    const content = document.getElementById('recommendationContent');
    
    if (panel && content) {
        panel.style.display = 'block';
        content.innerHTML = `
            <div style="margin-bottom:6px;"><strong>Êé®Â•®„ÉÜ„É≥„Éó„É¨„Éº„Éà:</strong> ${recommendation.template}</div>
            <div style="margin-bottom:6px;"><strong>„Ç≠„É£„É©ÈÖçÁΩÆ:</strong> ${recommendation.layout}</div>
            <div style="margin-bottom:6px;"><strong>„Ç´„É°„É©„ÉØ„Éº„ÇØ:</strong> ${recommendation.cameraWork}</div>
            <div style="color:#666; font-size:9px;">${recommendation.tips}</div>
        `;
    }
}

function applyRecommendation() {
    const recommendation = sceneRecommendations[currentScene];
    if (!recommendation) return;
    
    console.log('‚ú® Êé®Â•®Ë®≠ÂÆöÈÅ©Áî®:', currentScene);
    
    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®
    loadTemplate(recommendation.template);
    
    // „Ç≠„É£„É©ÈÖçÁΩÆÈÅ©Áî®ÔºàÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„ÇãÔºâ
    setTimeout(() => {
        if (selectedPanel) {
            applyCharacterLayout(recommendation.layout);
        }
    }, 100);
    
    // „Ç´„É°„É©„ÉØ„Éº„ÇØË®≠ÂÆö
    const cameraWorkEl = document.getElementById('cameraWork');
    if (cameraWorkEl) {
        cameraWorkEl.value = recommendation.cameraWork;
    }
}

// ===== „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà =====
function handleKeyDown(e) {
    // Ctrl/Cmd „Ç≠„Éº„Å®„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 's':
                e.preventDefault();
                saveProject();
                break;
            case 'e':
                e.preventDefault();
                exportToClipStudio();
                break;
            case 'z':
                e.preventDefault();
                // UndoÊ©üËÉΩÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
                console.log('üîÑ Undo (Êú™ÂÆüË£Ö)');
                break;
            case 'y':
                e.preventDefault();
                // RedoÊ©üËÉΩÔºàÂ∞ÜÊù•ÂÆüË£ÖÔºâ
                console.log('üîÑ Redo (Êú™ÂÆüË£Ö)');
                break;
        }
        return;
    }
    
    // Âçò‰Ωì„Ç≠„Éº
    switch(e.key) {
        case 'Delete':
        case 'Backspace':
            if (selectedElement) {
                deleteSelected();
            }
            break;
        case 'Escape':
            clearSelection();
            break;
        case 'g':
            // „Ç¨„Ç§„ÉâË°®Á§∫Âàá„ÇäÊõø„Åà
            const showGuides = document.getElementById('showGuides');
            if (showGuides) {
                showGuides.checked = !showGuides.checked;
                toggleGuides();
            }
            break;
    }
}

// ===== Âá∫ÂäõÊ©üËÉΩ =====
function exportToClipStudio() {
    const projectData = {
        pages: [{
            pageNumber: currentPage,
            panels: panels,
            characters: characters,
            speechBubbles: speechBubbles,
            canvas: {
                width: canvas.width,
                height: canvas.height
            },
            metadata: {
                scene: currentScene,
                created: new Date().toISOString()
            }
        }]
    };
    
    console.log('üé® „ÇØ„É™„Çπ„ÇøÁî®„Éá„Éº„ÇøÂá∫Âäõ:', projectData);
    
    const jsonData = JSON.stringify(projectData, null, 2);
    const blob = new Blob([jsonData], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `name_project_page${currentPage}.json`;
    a.click();
    
    URL.revokeObjectURL(url);
    alert('üéâ „ÇØ„É™„Çπ„ÇøÁî®„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„ÇíÂá∫Âäõ„Åó„Åæ„Åó„ÅüÔºÅ');
}

function exportToPDF() {
    alert('üìÑ PDFÂá∫ÂäõÊ©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô„ÄÇÁèæÂú®„ÅØPNGÂá∫Âäõ„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
}

function exportToPNG() {
    const link = document.createElement('a');
    link.download = `name_page${currentPage}.png`;
    link.href = canvas.toDataURL();
    link.click();
    alert('üñºÔ∏è PNGÁîªÂÉè„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
}

function saveProject() {
    const projectData = {
        currentPage: currentPage,
        currentScene: currentScene,
        pages: [{
            panels: panels,
            characters: characters,
            speechBubbles: speechBubbles
        }],
        metadata: {
            created: new Date().toISOString(),
            version: '1.0'
        }
    };
    
    localStorage.setItem('nameProject', JSON.stringify(projectData));
    console.log('üíæ „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰øùÂ≠òÂÆå‰∫Ü');
    alert('üíæ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
}

console.log('‚úÖ interaction.js Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
